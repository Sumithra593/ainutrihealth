
from flask import Flask, request, jsonify, send_from_directory
import os, io, json
from werkzeug.utils import secure_filename
from PIL import Image
import pytesseract
import cv2
import numpy as np
import joblib

UPLOAD_FOLDER = "uploads"
MODEL_PATH = "model.pkl"
ALLOWED_EXT = {"png","jpg","jpeg","tiff","bmp"}

os.makedirs(UPLOAD_FOLDER, exist_ok=True)

app = Flask(__name__)
app.config["UPLOAD_FOLDER"] = UPLOAD_FOLDER

ALLERGENS = {
    "milk": ["milk","lactose","whey","casein","butter","cheese","cream","yogurt"],
    "egg": ["egg","albumin","ovalbumin"],
    "soy": ["soy","soya","soybean","soy lecithin"],
    "gluten": ["wheat","barley","rye","malt","triticale","semolina"],
    "nuts": ["almond","walnut","cashew","pistachio","hazelnut","peanut","peanut"],
    "fish": ["fish","anchovy","salmon","tuna"],
    "sesame": ["sesame","tahini"],
    "shellfish": ["shrimp","prawn","crab","lobster"]
}

def allowed_file(filename):
    return "." in filename and filename.rsplit(".",1)[1].lower() in ALLOWED_EXT

def preprocess_image_for_ocr(img_path):
    img = cv2.imread(img_path)
    if img is None:
        raise ValueError("Image not readable by OpenCV")
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    gray = cv2.fastNlMeansDenoising(gray, h=10)
    th = cv2.adaptiveThreshold(gray,255,cv2.ADAPTIVE_THRESH_GAUSSIAN_C, cv2.THRESH_BINARY,11,2)
    return th

def ocr_image_to_text(img_path):
    th = preprocess_image_for_ocr(img_path)
    pil_img = Image.fromarray(th)
    text = pytesseract.image_to_string(pil_img, lang='eng')
    return text

def parse_ingredients(text):
    lines = []
    for part in text.splitlines():
        part = part.strip()
        if not part:
            continue
        part = part.replace("Ingredients:", "").replace("INGREDIENTS:", "")
        lines.append(part)
    joined = " ".join(lines)
    items = [i.strip().lower() for i in joined.replace(";",",").split(",") if i.strip()]
    final = []
    for it in items:
        if " and " in it and len(it.split(" and "))<=4:
            final += [x.strip() for x in it.split(" and ")]
        else:
            final.append(it)
    seen = set()
    ordered = []
    for i in final:
        if i not in seen:
            ordered.append(i)
            seen.add(i)
    return ordered

def detect_allergens(ingredients):
    detected = {}
    for alg, keywords in ALLERGENS.items():
        for ing in ingredients:
            for kw in keywords:
                if kw in ing:
                    detected.setdefault(alg, set()).add(ing)
    return {k:list(sorted(v)) for k,v in detected.items()}

def compute_health_score(ingredients):
    if os.path.exists(MODEL_PATH):
        try:
            model = joblib.load(MODEL_PATH)
            import numpy as np
            feats = []
            for ing in ingredients:
                feats.append([len(ing), int(any(ch.isdigit() for ch in ing)), int("e" in ing and any(ch.isdigit() for ch in ing))])
            X = np.mean(feats, axis=0).reshape(1,-1)
            score = int(max(0, min(100, 100 - model.predict(X)[0])))
            return score
        except Exception:
            pass
    score = 100
    for ing in ingredients:
        if any(x in ing for x in ["sugar","corn syrup","high fructose","maltodextrin","glucose","dextrose"]):
            score -= 15
        if any(x in ing for x in ["hydrogenated","partially hydrogenated","trans fat","shortening"]):
            score -= 20
        if any(x.isdigit() for x in ing) and "e" in ing:
            score -= 10
        if any(x in ing for x in ["salt","sodium"]):
            score -= 5
    return max(0, score)

from flask import Flask
@app.route("/ping")
def ping():
    return "pong"

@app.route("/scan", methods=["POST"])
def scan():
    if "image" not in request.files:
        return jsonify({"error":"no image provided"}), 400
    f = request.files["image"]
    if f.filename=="":
        return jsonify({"error":"empty filename"}), 400
    if not allowed_file(f.filename):
        return jsonify({"error":"file type not allowed"}), 400
    filename = secure_filename(f.filename)
    path = os.path.join(UPLOAD_FOLDER, filename)
    f.save(path)
    try:
        text = ocr_image_to_text(path)
    except Exception as e:
        return jsonify({"error":"ocr failed", "details": str(e)}), 500
    ingredients = parse_ingredients(text)
    allergens = detect_allergens(ingredients)
    health_score = compute_health_score(ingredients)
    recommendations = []
    if allergens:
        recommendations.append({"reason":"contains listed allergens", "suggestion":"search for 'allergen-free' products or check labels"})
    result = {
        "filename": filename,
        "raw_text": text,
        "ingredients": ingredients,
        "allergens_detected": allergens,
        "health_score": health_score,
        "recommended_actions": recommendations
    }
    return jsonify(result)

@app.route("/model/status")
def model_status():
    return jsonify({"model_exists": os.path.exists(MODEL_PATH)})

@app.route("/model/download")
def model_download():
    if not os.path.exists(MODEL_PATH):
        return jsonify({"error":"no model available"}), 404
    return send_from_directory(".", os.path.basename(MODEL_PATH), as_attachment=True)

if __name__ == "__main__":
    from flask import Flask
    app.run(host="0.0.0.0", port=5000, debug=True)
